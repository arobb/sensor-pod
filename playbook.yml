---
- hosts: all
  remote_user: root
  vars:
    gitPath: /home/pi/git
    piGenPath: "{{ gitPath }}/pi-gen"

  tasks:
    - name: Install dependencies
      apt:
        pkg:
          - sudo
          - build-essential
          - module-assistant
          - quilt
          - parted
          - realpath
          - qemu-user-static
          - debootstrap
          - zerofree
          - pxz
          - zip
          - dosfstools
          - bsdtar
          - libcap2-bin
          - grep
          - rsync
          - xz-utils
          - file
          - git
          - curl
          - vim
          - apt-cacher-ng
        state: present

    # https://stackoverflow.com/a/37334415
    - name: Make sure we have a 'wheel' group
      group:
        name: wheel
        state: present

    - name: Allow 'wheel' group to have passwordless sudo
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: '^%wheel'
        line: '%wheel ALL=(ALL) NOPASSWD: ALL'
        validate: 'visudo -cf %s'

    # https://stackoverflow.com/a/19318368
    # openssl passwd -salt <salt> -1 <plaintext>
    # openssl passwd -salt 'My$@1t' -1 'raspberry'
    - name: Configure pi user account
      user:
        name: pi
        password: $1$My$@1t$g3URvhJ2y71Ol3qDP86fV1
        groups: wheel
        append: yes
        state: present
        createhome: yes

    - name: Clone repo
      git:
        repo: https://github.com/arobb/pi-gen.git
        dest: "{{ piGenPath }}"
        version: sensor-pod

    - name: Create the config file
      file:
        path: "{{ piGenPath }}/config"
        state: touch

    - name: Create stage touch files
      file:
        path: "{{ item }}"
        state: touch
      with_items:
        - "{{ piGenPath }}/stage3/SKIP"
        - "{{ piGenPath }}/stage4/SKIP"
        - "{{ piGenPath }}/stage5/SKIP"
        - "{{ piGenPath }}/stage4/SKIP_IMAGES"
        - "{{ piGenPath }}/stage5/SKIP_IMAGES"
